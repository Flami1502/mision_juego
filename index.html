<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#1b1a22" />
  <title>Misi√≥n</title>

  <style>
    :root{
      --bg0:#15141b; --bg1:#1c1a24; --bg2:#252235;
      --card: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.12);
      --text:#f2f2f6;
      --muted:#c8c8d6;
      --muted2:#a7a7ba;
      --accent:#d35c7a;
      --ok:#35b37e;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 22px;
      --focus: 0 0 0 3px rgba(211,92,122,.28);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--text);
      background:
        radial-gradient(1000px 700px at 15% 0%, rgba(211,92,122,.18), transparent 60%),
        radial-gradient(900px 650px at 85% 20%, rgba(53,179,126,.12), transparent 55%),
        radial-gradient(1200px 900px at 50% 100%, rgba(255,255,255,.06), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 45%, var(--bg2));
      display:grid;
      place-items:center;
      padding:16px;
      line-height:1.35;
    }
    .app{ width:100%; max-width:760px; display:grid; gap:14px; }
    header{ display:flex; align-items:center; gap:10px; padding:4px 2px 0; }
    .dot{
      width:12px;height:12px;border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 0 7px rgba(211,92,122,.14);
      flex:0 0 auto;
    }
    header h1{
      font-size:14px; color: var(--muted2); margin:0; font-weight:900; letter-spacing:.2px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.06));
      border:1px solid var(--border);
      border-radius: calc(var(--radius) + 6px);
      box-shadow: var(--shadow);
      padding:18px;
      backdrop-filter: blur(12px);
    }
    .progress{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:12px 14px;
      border-radius: var(--radius);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }
    .progress .label{ font-size:13px; color: var(--muted2); font-weight:950; }
    .pills{ display:flex; gap:6px; align-items:center; }
    .pill{
      width:34px;height:10px;border-radius:999px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.10);
    }
    .pill.on{ background: rgba(211,92,122,.55); border-color: rgba(211,92,122,.35); }
    .pill.done{ background: rgba(53,179,126,.50); border-color: rgba(53,179,126,.25); }

    .screen{ outline:none; animation: fadeUp .35s ease both; }
    @keyframes fadeUp{ from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:none} }

    .title{ margin:0; font-size:30px; letter-spacing:-.3px; line-height:1.1; }
    .subtitle{ margin:0; color: var(--muted); font-size:15px; }

    .badge{
      display:inline-flex; align-items:center; gap:8px; width:fit-content;
      padding:8px 12px; border-radius:999px;
      font-weight:950; font-size:13px; color: rgba(255,255,255,.92);
      background: rgba(211,92,122,.16);
      border:1px solid rgba(211,92,122,.28);
    }
    .badge.ok{ background: rgba(53,179,126,.16); border-color: rgba(53,179,126,.26); }

    .panel{
      border-radius: var(--radius);
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      padding:14px;
      display:grid;
      gap:10px;
    }
    .clue{ margin:0; font-size:20px; letter-spacing:-.2px; font-weight:900; }

    .row{ display:grid; gap:12px; margin-top:6px; }
    @media(min-width:640px){ .row{ grid-template-columns: 1.2fr .8fr; } }

    .btn{
      border:0;
      border-radius: 18px;
      padding:16px 16px;
      font-size:16px;
      font-weight:950;
      cursor:pointer;
      transition: transform .08s ease, filter .2s ease, background .2s ease, opacity .2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: scale(.985); }
    .btn:focus-visible{ outline:none; box-shadow: var(--focus); }
    .btn-primary{
      color:#fff;
      background: linear-gradient(180deg, var(--accent), #b54b65);
      box-shadow: 0 16px 35px rgba(211,92,122,.20);
      text-decoration:none;
      text-align:center;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .btn-ghost{
      color: var(--text);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
    }
    .btn-done{
      color:#fff;
      background: linear-gradient(180deg, var(--ok), #2a8e66);
      box-shadow: 0 16px 35px rgba(53,179,126,.16);
    }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

    .riddle{
      display:grid; gap:10px;
      border-radius: var(--radius);
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      padding:14px;
    }
    .riddle .q{ margin:0; font-weight:950; letter-spacing:-.1px; }
    .riddle .hint{ margin:0; font-size:13px; color: var(--muted); font-weight:700; }
    .inputRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input[type="text"]{
      flex: 1 1 220px;
      min-width: 180px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:12px 12px;
      font-size:16px;
      outline:none;
    }
    input[type="text"]::placeholder{ color: rgba(200,200,214,.70); }
    input[type="text"]:focus{ box-shadow: var(--focus); border-color: rgba(211,92,122,.35); }

    .miniBtn{
      padding:12px 14px;
      border-radius: 14px;
      font-size:14px;
      font-weight:950;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor: pointer;
    }
    .miniBtn:focus-visible{ outline:none; box-shadow: var(--focus); }

    .mapReveal{
      display:grid;
      gap:10px;
      border-radius: var(--radius);
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.10);
      padding:14px;
    }
    .mapReveal .small{ margin:0; color: var(--muted); font-size:13px; font-weight:700; }

    .heroImg{
      width:100%;
      height:auto;
      display:block;
      max-width:100%;
      border-radius: calc(var(--radius) - 6px);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform: translateX(-50%);
      background: rgba(10,10,14,.92);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      z-index:150;
      max-width: calc(100% - 24px);
      text-align:center;
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(10px);
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-4px); }

    .sr-only{
      position:absolute;width:1px;height:1px;
      padding:0;margin:-1px;overflow:hidden;
      clip:rect(0,0,0,0);white-space:nowrap;border:0;
    }

    @media (prefers-reduced-motion: reduce){
      *{ animation:none !important; transition:none !important; }
    }
  </style>
</head>

<body>
  <div class="app" role="application" aria-label="Juego por misiones">
    <header>
      <span class="dot" aria-hidden="true"></span>
      <h1>Misi√≥n</h1>
    </header>

    <div class="card progress" aria-label="Progreso">
      <div class="label" id="progressLabel">Listo para empezar</div>
      <div class="pills" aria-hidden="true">
        <span class="pill" id="pill1"></span>
        <span class="pill" id="pill2"></span>
        <span class="pill" id="pill3"></span>
      </div>
    </div>

    <main id="screen" class="card screen" tabindex="-1" aria-live="polite"></main>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
    <p class="sr-only">Tu progreso se guarda autom√°ticamente.</p>
  </div>

  <script>
    (function () {
      "use strict";

      const STORAGE_KEY = "mision_v4";

      const SCREENS = {
        instructions: {
          title: "Antes de empezar",
          text: "Cada vez que avances una misi√≥n, tienes que enviarme una foto como prueba üòåüì∏",
          button: "Entendido"
        },
        start: {
          title: "Misi√≥n",
          subtitle: "Sigue las pistas paso a paso",
          button: "Empezar"
        },
        missions: [
          { title: "Misi√≥n 1", text: "Algo que huela bien y no se coma üåπ" },
          { title: "Misi√≥n 2", text: "Algo dulce que se coma despacio üç´" },
          { title: "Misi√≥n 3", text: "Algo que se beba con calma üç∑" }
        ],
        final: {
          title: "Felicidades nena espero que haya valido la pena ahora y feliz pre...!",
          text: "Vuelve con todo que el nene espera en casaüòå",
          home: "¬°Regresa a casa! üè°üíõ"
        }
      };

      // ‚úÖ Misi√≥n 2 ya NO es acertijo: es "poner un c√≥digo"
      // IMPORTANTE: me pediste poner el texto tal cual:
      const GATE_TEXT_M2 = "una vez con las flores mandale fotico al nene que te dara el codigo, ponlo talcual";

      const RIDDLES = [
        { q: "Acertijo: Entre aves y metros, segundo finde en madrid, el nene te esperaba con una sorpresa en las manos ¬øQue fue?", answers: ["flor","rosa","flores","rosas"] },

        // M2: "c√≥digo" (sin respuesta hardcodeada aqu√≠). Se valida contra un c√≥digo que t√∫ pondr√°s.
        // Dejo un placeholder seguro: cambia CODE_M2 por tu c√≥digo real cuando lo tengas.
        { q: "C√≥digo:", answers: [] },

        { q: "Acertijo: Se toma, previo al horrorland, invitacion de tu mama.¬ø que bebida es ?", answers: ["vino","un vino"] }
      ];

      // ‚úÖ PON AQU√ç el c√≥digo real de la misi√≥n 2 cuando lo tengas (ej: "1234" o "NEA")
      // Por ahora dejo un placeholder:
      const CODE_M2 = "yesebigotenena";

      const MAP_LINKS = [
        { label: "Busca el presente", url: "https://www.google.com/maps/search/Rosistirem+Cornell%C3%A0+de+Llobregat" },
        { label: "Se busca postre en la siguiente ubicaci√≥n", url: "https://www.google.com/maps/dir/?api=1&destination=Pasteler√≠a+Abril" },
        { label: "Compra vino y vuelve a casa", url: "https://www.google.com/maps/search/Lidl+Esplugues+de+Llobregat" }
      ];

      const INTRO_IMAGE = {
        src: "intro.jpg",
        alt: "Imagen de introducci√≥n de la aventura"
      };

      const defaultState = {
        step: "instructions",
        mission: 0,
        riddleSolved: [false,false,false],
        mapsOpened:   [false,false,false],
        missionDone:  [false,false,false]
      };

      let state = loadState();

      const screen = document.getElementById("screen");
      const progressLabel = document.getElementById("progressLabel");
      const pill1 = document.getElementById("pill1");
      const pill2 = document.getElementById("pill2");
      const pill3 = document.getElementById("pill3");
      const toast = document.getElementById("toast");

      function loadState(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          if(!raw) return { ...defaultState };
          const s = JSON.parse(raw);
          const safe = { ...defaultState, ...s };
          if(!Array.isArray(safe.riddleSolved) || safe.riddleSolved.length !== 3) safe.riddleSolved = [...defaultState.riddleSolved];
          if(!Array.isArray(safe.mapsOpened)  || safe.mapsOpened.length  !== 3) safe.mapsOpened  = [...defaultState.mapsOpened];
          if(!Array.isArray(safe.missionDone) || safe.missionDone.length !== 3) safe.missionDone = [...defaultState.missionDone];
          safe.mission = Math.min(Math.max(parseInt(safe.mission,10) || 0, 0), 3);
          safe.step = ["instructions","start","mission","final"].includes(safe.step) ? safe.step : "instructions";
          return safe;
        }catch{
          return { ...defaultState };
        }
      }

      function saveState(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch{} }

      function normalize(str){
        return (str || "")
          .toString()
          .trim()
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "");
      }

      function showToast(msg){
        toast.textContent = msg;
        toast.classList.add("show");
        clearTimeout(showToast._t);
        showToast._t = setTimeout(()=>toast.classList.remove("show"), 1800);
      }

      function setProgressUI(){
        const pills = [pill1,pill2,pill3];
        pills.forEach((p,i)=>{
          p.classList.remove("on","done");
          if(state.missionDone[i]) p.classList.add("done");
          else if(state.step === "mission" && state.mission === i) p.classList.add("on");
        });

        if(state.step === "instructions") progressLabel.textContent = "Instrucciones";
        else if(state.step === "start") progressLabel.textContent = "Listo para empezar";
        else if(state.step === "final") progressLabel.textContent = "Completado ‚úÖ";
        else progressLabel.textContent = `En misi√≥n ${state.mission + 1} de 3`;
      }

      function resetAll(){
        state = { ...defaultState };
        saveState();
        render();
        showToast("Progreso reiniciado");
      }

      function render(){
        setProgressUI();

        if(state.missionDone.every(Boolean)){
          state.step = "final";
          saveState();
        }

        if(state.step === "instructions"){
          screen.innerHTML = `
            <div class="badge">Importante</div>
            <h2 class="title">${SCREENS.instructions.title}</h2>
            <div class="panel">
              <p class="clue">${SCREENS.instructions.text}</p>
            </div>
            <div class="row">
              <button class="btn btn-primary" id="toStart" type="button">${SCREENS.instructions.button}</button>
              <button class="btn btn-ghost" id="resetBtn" type="button">Reiniciar</button>
            </div>
          `;
          document.getElementById("toStart").onclick = () => { state.step = "start"; saveState(); render(); };
          document.getElementById("resetBtn").onclick = resetAll;
        }

        else if(state.step === "start"){
          screen.innerHTML = `
            <h2 class="title">${SCREENS.start.title}</h2>
            <p class="subtitle">${SCREENS.start.subtitle}</p>

            <div class="panel" aria-label="Introducci√≥n">
              <img class="heroImg" src="${INTRO_IMAGE.src}" alt="${INTRO_IMAGE.alt}">
            </div>

            <div class="row">
              <button class="btn btn-primary" id="startBtn" type="button">${SCREENS.start.button}</button>
              <button class="btn btn-ghost" id="resetBtn" type="button">Reiniciar</button>
            </div>
          `;
          document.getElementById("startBtn").onclick = () => { state.step = "mission"; state.mission = 0; saveState(); render(); };
          document.getElementById("resetBtn").onclick = resetAll;
        }

        else if(state.step === "mission"){
          const i = state.mission;
          const m = SCREENS.missions[i];
          const link = MAP_LINKS[i];

          const solved = !!state.riddleSolved[i];
          const mapsOpened = !!state.mapsOpened[i];
          const done = !!state.missionDone[i];

          const doneEnabled = solved && mapsOpened && !done;
          const nextEnabled = done;

          // ‚úÖ misi√≥n 2: panel especial (pediste ‚Äúponlo tal cual‚Äù)
          const isMission2 = (i === 1);

          screen.innerHTML = `
            <div class="badge ${done ? "ok" : ""}">${done ? "Completada ‚úÖ" : "Paso a paso"}</div>
            <h2 class="title">${m.title}</h2>

            ${!solved ? `
              <div class="riddle" aria-label="${isMission2 ? "C√≥digo" : "Acertijo"}">
                ${isMission2 ? `
                  <p class="q">${GATE_TEXT_M2}</p>
                  <p class="hint">Escribe el c√≥digo que te dar√° el nene.</p>
                ` : `
                  <p class="q">${RIDDLES[i].q}</p>
                  <p class="hint">Resu√©lvelo para desbloquear la ubicaci√≥n.</p>
                `}
                <div class="inputRow">
                  <input id="answer" type="text" autocomplete="off" inputmode="text"
                    placeholder="${isMission2 ? "Introduce el c√≥digo..." : "Escribe tu respuesta..."}"
                    aria-label="${isMission2 ? "C√≥digo" : "Respuesta del acertijo"}" />
                  <button id="checkBtn" class="miniBtn" type="button" aria-label="${isMission2 ? "Comprobar c√≥digo" : "Comprobar acertijo"}">
                    Comprobar
                  </button>
                </div>
              </div>
            ` : `
              <div class="panel">
                <p class="clue">${m.text}</p>
              </div>

              <div class="mapReveal" aria-label="Ubicaci√≥n en Google Maps">
                <p class="clue" style="font-size:18px;">Ubicaci√≥n desbloqueada ‚úÖ</p>
                <p class="small">${link.label}</p>

                <a class="btn btn-primary" id="mapsBtn" href="${link.url}" target="_blank" rel="noopener"
                   aria-label="Abrir Google Maps">
                  Abrir en Google Maps
                </a>

                <p class="small">
                  ${mapsOpened
                    ? "Perfecto ‚úÖ Cuando lo tengas, pulsa <b>Hecho ‚úÖ</b> y <b>env√≠ame una foto</b> üì∏"
                    : "Primero pulsa <b>Abrir en Google Maps</b> para ver la ubicaci√≥n."}
                </p>
              </div>
            `}

            <div class="row">
              <button class="btn btn-primary" id="nextBtn" type="button" ${nextEnabled ? "" : "disabled"}>Siguiente pista</button>
              <button class="btn btn-done" id="doneBtn" type="button" ${doneEnabled ? "" : "disabled"}>Hecho ‚úÖ</button>
            </div>

            <button class="btn btn-ghost" id="resetBtn" type="button">Reiniciar</button>
          `;

          document.getElementById("resetBtn").onclick = resetAll;

          const checkBtn = document.getElementById("checkBtn");
          if(checkBtn){
            checkBtn.onclick = () => {
              const typed = normalize(document.getElementById("answer").value);

              let ok = false;

              if(i === 1){
                // ‚úÖ Misi√≥n 2: valida contra el c√≥digo
                ok = (typed === normalize(CODE_M2));
                if(ok){
                  state.riddleSolved[i] = true;
                  saveState();
                  showToast("C√≥digo correcto ‚úÖ Ubicaci√≥n desbloqueada");
                  render();
                }else{
                  showToast("C√≥digo incorrecto‚Ä¶ prueba otra vez üòå");
                }
                return;
              }

              // M1 y M3: acertijos normales
              ok = RIDDLES[i].answers.map(a => normalize(a)).includes(typed);
              if(ok){
                state.riddleSolved[i] = true;
                saveState();
                showToast("Correcto ‚úÖ Ubicaci√≥n desbloqueada");
                render();
              }else{
                showToast("No es‚Ä¶ prueba otra palabra üòå");
              }
            };
          }

          const mapsBtn = document.getElementById("mapsBtn");
          if(mapsBtn){
            mapsBtn.addEventListener("click", () => {
              if(!state.mapsOpened[i]){
                state.mapsOpened[i] = true;
                saveState();
                showToast("Maps listo ‚úÖ Luego: Hecho ‚úÖ + foto üì∏");
              }
            });
            window.addEventListener("focus", () => render(), { once: true });
          }

          document.getElementById("doneBtn").onclick = () => {
            if(!(state.riddleSolved[i] && state.mapsOpened[i])) return;
            state.missionDone[i] = true;
            saveState();
            showToast("Perfecto ‚úÖ Env√≠ame una foto üì∏");
            render();
          };

          document.getElementById("nextBtn").onclick = () => {
            if(!state.missionDone[i]) return;
            state.mission = i + 1;
            state.step = (state.mission >= 3) ? "final" : "mission";
            saveState();
            render();
          };
        }

        else { // final
          screen.innerHTML = `
            <div class="badge ok">${SCREENS.final.home}</div>
            <h2 class="title">${SCREENS.final.title}</h2>
            <div class="panel">
              <p class="clue">${SCREENS.final.text}</p>
            </div>
            <div class="row">
              <button class="btn btn-primary" id="restartBtn" type="button">Empezar de nuevo</button>
              <button class="btn btn-ghost" id="resetBtn" type="button">Reiniciar</button>
            </div>
          `;
          document.getElementById("restartBtn").onclick = () => {
            state.step = "start";
            state.mission = 0;
            state.riddleSolved = [false,false,false];
            state.mapsOpened = [false,false,false];
            state.missionDone = [false,false,false];
            saveState();
            render();
          };
          document.getElementById("resetBtn").onclick = resetAll;
        }

        screen.focus({ preventScroll: true });
      }

      render();
    })();
  </script>
</body>
</html>
